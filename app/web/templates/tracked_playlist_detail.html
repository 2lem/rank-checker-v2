<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ playlist.name }} · Tracked Playlist</title>
    <link rel="stylesheet" href="/static/ui.css" />
    <link rel="stylesheet" href="/static/tracked.css" />
    <script src="/static/basic-scan.js"></script>
    <script src="/static/scan-runner.js"></script>
  </head>
  <body class="app-body">
    <main class="page">
      <header class="page-header">
        <div>
          <h1 class="page-title dashboard-title" title="{{ playlist.dashboard_header_title }}">
            <span class="dashboard-title-prefix">Dashboard</span>
          </h1>
        </div>
        <div class="page-header-actions">
          <button class="btn btn-tracked-outline dashboard-action-btn" type="button">Tracked Playlist</button>
          <button class="btn btn-primary dashboard-action-btn" type="button" data-refresh-stats>Refresh Stats</button>
          {% set label = 'Back To Tracked Playlists' %}
          {% set button_variant = 'ghost' %}
          {% set href = '/' %}
          {% set extra_class = 'btn-back-blue dashboard-action-btn' %}
          {% include "_components/button.html" %}
        </div>
      </header>

      <section class="ui-card status-card">
        <div class="status-card-header">
          <h2>Status</h2>
          <p class="status-card-subtitle">Live feedback for playlist actions.</p>
        </div>
        <div id="playlist-status" class="status-area" role="status" aria-live="polite">
          Ready to refresh playlist metadata.
        </div>
      </section>

      <div class="tracked-detail-stack">
        {% set variant = 'detail' %}
        {% include "_components/tracked_card.html" %}

        <section class="toolbar-panel">
          <div class="toolbar-actions">
            <button class="btn btn-secondary" type="button" data-basic-scan-toggle aria-expanded="false">
              Basic Scan (Manual)
            </button>
          </div>
        </section>

        <section class="panel basic-scan-panel is-hidden" id="basic-scan-section">
          <div class="panel-header">
            <h2>Basic Scan Panel</h2>
            <p>Run a manual scan using stored targets.</p>
          </div>
          <div class="panel-body">
            <div class="basic-scan" data-basic-scan>
              <section class="scan-parameters" id="scan-parameters" data-basic-scan-parameters>
                <div class="scan-config-row">
                  <span class="scan-config-label">Countries</span>
                  <div class="pill-list" data-basic-scan-countries>
                    {% if playlist.target_countries %}
                      {% for country in playlist.target_countries %}
                        {% set label = playlist.target_country_labels.get(country|upper, country) %}
                        <span class="chip chip-locked">
                          <span class="chip-label">{{ label }}</span>
                        </span>
                      {% endfor %}
                    {% else %}
                      <span class="scan-config-empty">No target countries</span>
                    {% endif %}
                  </div>
                </div>
                <div class="scan-config-row">
                  <span class="scan-config-label">Keywords</span>
                  <div class="pill-list" data-basic-scan-keywords>
                    {% if playlist.target_keywords %}
                      {% for keyword in playlist.target_keywords %}
                        <span class="chip chip-locked">
                          <span class="chip-label">{{ keyword }}</span>
                        </span>
                      {% endfor %}
                    {% else %}
                      <span class="scan-config-empty">No target keywords</span>
                    {% endif %}
                  </div>
                </div>
                <div class="run-scan-controls" id="run-scan-controls" data-basic-scan-run-controls>
                  <button class="btn btn-primary" type="button" data-basic-scan-run>Run Basic Scan</button>
                </div>
              </section>
              <section
                class="run-progress basic-scan-progress"
                id="basic-scan-progress"
                data-basic-scan-progress
                hidden
              >
                <div class="progress-bar">
                  <div class="progress-fill" data-basic-scan-progress-fill></div>
                </div>
                <div class="progress-status" data-basic-scan-progress-status>Starting scan…</div>
                <div class="progress-log" data-basic-scan-progress-log></div>
              </section>
              <section class="results" id="basic-scan-results" data-basic-scan-results hidden>
                <div class="results-header">
                  <h3>Basic Scan Results</h3>
                  <div
                    class="download-csv-controls basic-scan-download-actions"
                    id="basic-scan-csv-controls"
                    data-basic-scan-csv-controls
                  >
                    <a class="btn btn-csv" data-basic-scan-export-summary>Download Summary CSV</a>
                    <a class="btn btn-csv" data-basic-scan-export-detailed>Download Detailed CSV</a>
                  </div>
                </div>
                <div class="summary" id="basic-scan-summary">
                  <h3>Summary</h3>
                  <div class="summary-lead" data-basic-scan-summary-lead></div>
                  <div class="summary-list" data-basic-scan-summary-list></div>
                </div>
                <div class="detailed-scan-insights" id="basic-scan-detailed">
                  <h3>Detailed Scan Insights</h3>
                  <div class="detailed-insights" data-basic-scan-detailed></div>
                </div>
              </section>
            </div>
          </div>
        </section>
      </div>
    </main>

    <script>
      const statusArea = document.getElementById('playlist-status');
      const refreshButton = document.querySelector('[data-refresh-stats]');
      const toolbarButtons = document.querySelectorAll('[data-panel-target]');
      const panels = document.querySelectorAll('.panel[data-panel]');
      const toolbar = document.querySelector('.toolbar-panel');
      let lastAnchor = toolbar;
      const basicScanToggle = document.querySelector('[data-basic-scan-toggle]');
      const basicScanSection = document.getElementById('basic-scan-section');
      let basicScanController = null;
      let preOpenScrollY = null;

      const togglePanel = (targetId) => {
        let activePanel = null;
        panels.forEach((panel) => {
          if (panel.id === targetId) {
            activePanel = panel;
          }
        });

        if (!activePanel) {
          return;
        }

        const isActive = activePanel.classList.contains('is-active');
        panels.forEach((panel) => panel.classList.remove('is-active'));

        if (!isActive) {
          lastAnchor = toolbar || document.body;
          activePanel.classList.add('is-active');
          activePanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
          return;
        }

        if (lastAnchor) {
          lastAnchor.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      };

      toolbarButtons.forEach((button) => {
        button.addEventListener('click', () => {
          togglePanel(button.dataset.panelTarget);
        });
      });

      if (panels.length) {
        panels[0].classList.add('is-active');
      }

      const toggleBasicScan = () => {
        if (!basicScanSection || !basicScanToggle) {
          return;
        }
        const isHidden = basicScanSection.classList.contains('is-hidden');
        if (isHidden) {
          preOpenScrollY = window.scrollY;
          basicScanSection.classList.remove('is-hidden');
          basicScanSection.classList.add('is-active');
          basicScanToggle.setAttribute('aria-expanded', 'true');
          if (basicScanController) {
            basicScanController.openStage1();
          }
          const fallbackTarget = document.getElementById('scan-parameters') || basicScanSection;
          BasicScan.scrollSectionToCenter(fallbackTarget);
          return;
        }
        basicScanSection.classList.add('is-hidden');
        basicScanSection.classList.remove('is-active');
        basicScanToggle.setAttribute('aria-expanded', 'false');
        if (preOpenScrollY !== null) {
          window.scrollTo({ top: preOpenScrollY, behavior: 'smooth' });
        }
      };

      basicScanToggle?.addEventListener('click', toggleBasicScan);

      const setStatus = (message, variant) => {
        if (!statusArea) {
          return;
        }
        statusArea.textContent = message;
        statusArea.classList.remove('status-success', 'status-error', 'status-loading');
        if (variant) {
          statusArea.classList.add(variant);
        }
      };

      refreshButton?.addEventListener('click', async () => {
        if (!refreshButton) {
          return;
        }
        refreshButton.disabled = true;
        setStatus('Fetching data from Spotify… please wait', 'status-loading');

        try {
          const response = await fetch(`/api/playlists/{{ playlist.id }}/refresh-stats`, {
            method: 'POST',
          });
          const data = await response.json().catch(() => ({}));

          if (!response.ok) {
            const detail = data.detail || 'Unable to refresh playlist metadata.';
            const message = typeof detail === 'string' ? detail : detail.message || JSON.stringify(detail);
            setStatus(message, 'status-error');
            refreshButton.disabled = false;
            return;
          }

          const refreshedAt = data.refreshed_at ? new Date(data.refreshed_at) : null;
        const timeLabel = refreshedAt ? refreshedAt.toLocaleString() : 'just now';
        setStatus(`✅ Playlist metadata refreshed at ${timeLabel}`, 'status-success');
        window.location.reload();
        } catch (error) {
          setStatus('Network error while refreshing playlist.', 'status-error');
          refreshButton.disabled = false;
        }
      });

      const availableMarkets = {{ available_markets | tojson }};
      const marketLabelMap = new Map(
        availableMarkets.map((market) => [market.code.toUpperCase(), market.label])
      );

      const resolveMarketLabel = (code) => marketLabelMap.get((code || '').toUpperCase()) || code;

      const formatTimestamp =
        (window.ScanRunner && window.ScanRunner.defaultFormatTimestamp) ||
        ((value) => {
          if (!value) {
            return '—';
          }
          const date = new Date(value);
          if (Number.isNaN(date.getTime())) {
            return value;
          }
          return new Intl.DateTimeFormat('sv-SE', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
          }).format(date);
        });

      const formatSummaryDateParts =
        (window.ScanRunner && window.ScanRunner.defaultFormatSummaryDateParts) ||
        ((value) => {
          if (!value) {
            return { dateLabel: '—', timeLabel: '—' };
          }
          const date = new Date(value);
          if (Number.isNaN(date.getTime())) {
            return { dateLabel: value, timeLabel: value };
          }
          const dateLabel = date.toLocaleDateString('en-GB', {
            day: 'numeric',
            month: 'long',
            year: 'numeric',
          });
          const timeLabel = date.toLocaleTimeString('en-GB', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: false,
          });
          return { dateLabel, timeLabel };
        });

      const formatFollowersValue = (value) => {
        if (value === undefined || value === null || value === '') {
          return '—';
        }
        if (typeof value === 'object') {
          if ('total' in value) {
            return formatFollowersValue(value.total);
          }
          return '—';
        }
        const numeric = Number(value);
        if (Number.isFinite(numeric)) {
          return numeric.toLocaleString();
        }
        return value;
      };

      const flagEmoji = (code) => {
        const upper = (code || '').toUpperCase();
        if (upper.length !== 2) {
          return '';
        }
        return upper.replace(/./g, (char) => String.fromCodePoint(127397 + char.charCodeAt()));
      };

      const createScanController =
        (window.ScanRunner && window.ScanRunner.createBasicScanController) || BasicScan?.init;

      if (createScanController) {
        basicScanController = createScanController({
          root: '[data-basic-scan]',
          resolveMarketLabel,
          formatTimestamp,
          formatSummaryDateParts,
          formatFollowersValue,
          onStatus: setStatus,
          getStartPayload: () => ({
            tracked_playlist_id: '{{ playlist.id }}',
            playlist_id: '{{ playlist.playlist_id }}',
            is_tracked_playlist: true,
          }),
          getTargetPlaylistId: () => '{{ playlist.playlist_id }}',
        });
      }

      window.addEventListener('beforeunload', () => {
        basicScanController?.dispose?.();
      });
    </script>
  </body>
</html>
