name: CI Functional Tests

on:
  pull_request:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  smoke_and_e2e:
    environment: production
    runs-on: ubuntu-latest
    outputs:
      readiness: ${{ steps.readiness.outputs.ready }}
      readiness_reason: ${{ steps.readiness.outputs.message }}
      smoke_status: ${{ steps.smoke_status.outputs.status }}
      e2e_status: ${{ steps.e2e_status.outputs.status }}
      e2e_summary: ${{ steps.e2e_status.outputs.summary }}
    env:
      BASE_URL: ${{ vars.BASE_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: Check test environment readiness
        id: readiness
        run: |
          if [ -z "${BASE_URL:-}" ]; then
            message="E2E/Smoke tests skipped: BASE_URL not set or backend not available"
            echo "$message"
            if [ -n "${GITHUB_STEP_SUMMARY:-}" ]; then
              echo "## Functional test gating" >> "$GITHUB_STEP_SUMMARY"
              echo "$message" >> "$GITHUB_STEP_SUMMARY"
            fi
            echo "ready=false" >> "$GITHUB_OUTPUT"
            echo "message=$message" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "ready=true" >> "$GITHUB_OUTPUT"
          echo "message=E2E/Smoke tests ready: BASE_URL is set" >> "$GITHUB_OUTPUT"
          echo "E2E/Smoke tests ready: BASE_URL is set"

      - name: Install dependencies
        if: steps.readiness.outputs.ready == 'true'
        run: npm install

      - name: Install Playwright browsers
        if: steps.readiness.outputs.ready == 'true'
        run: npx playwright install --with-deps chromium

      - name: Run smoke tests
        id: smoke
        if: steps.readiness.outputs.ready == 'true'
        continue-on-error: true
        env:
          TEST_TRACKED_PLAYLIST_ID: ${{ secrets.TEST_TRACKED_PLAYLIST_ID }}
          TEST_PLAYLIST_URL_OR_ID: ${{ secrets.TEST_PLAYLIST_URL_OR_ID }}
        run: node scripts/smoke.mjs

      - name: Run Playwright tests
        id: e2e
        if: steps.readiness.outputs.ready == 'true'
        continue-on-error: true
        env:
          TEST_TRACKED_PLAYLIST_ID: ${{ secrets.TEST_TRACKED_PLAYLIST_ID }}
          TEST_PLAYLIST_URL_OR_ID: ${{ secrets.TEST_PLAYLIST_URL_OR_ID }}
          BASIC_SCAN_PATH: ${{ secrets.BASIC_SCAN_PATH }}
          ADD_PLAYLIST_PATH: ${{ secrets.ADD_PLAYLIST_PATH }}
        run: npm run test:e2e

      - name: Summarize Playwright results
        id: e2e_summary
        if: always() && steps.readiness.outputs.ready == 'true'
        run: node scripts/summarize-playwright.mjs

      - name: Record smoke status
        id: smoke_status
        if: always()
        env:
          READY: ${{ steps.readiness.outputs.ready }}
          SMOKE_OUTCOME: ${{ steps.smoke.outcome }}
        run: |
          if [ "$READY" != "true" ]; then
            echo "status=skipped" >> "$GITHUB_OUTPUT"
            echo "reason=E2E/Smoke tests skipped: BASE_URL not set or backend not available" >> "$GITHUB_OUTPUT"
          else
            echo "status=$SMOKE_OUTCOME" >> "$GITHUB_OUTPUT"
          fi

      - name: Record e2e status
        id: e2e_status
        if: always()
        env:
          READY: ${{ steps.readiness.outputs.ready }}
          E2E_STATUS_RAW: ${{ steps.e2e_summary.outputs.e2e_status }}
          E2E_SUMMARY_RAW: ${{ steps.e2e_summary.outputs.e2e_summary }}
        run: |
          if [ "$READY" != "true" ]; then
            echo "status=skipped" >> "$GITHUB_OUTPUT"
            echo "summary=E2E/Smoke tests skipped: BASE_URL not set or backend not available" >> "$GITHUB_OUTPUT"
          else
            echo "status=${E2E_STATUS_RAW:-failure}" >> "$GITHUB_OUTPUT"
            echo "summary=${E2E_SUMMARY_RAW:-'- ⚠️ Playwright results not found'}" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload Playwright report
        if: always() && steps.readiness.outputs.ready == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report

      - name: Fail if tests failed
        if: ${{ steps.readiness.outputs.ready == 'true' && (steps.smoke.outcome != 'success' || steps.e2e.outcome != 'success') }}
        run: exit 1

  pr_comment:
    if: github.event_name == 'pull_request'
    needs: smoke_and_e2e
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Gather changed files
        id: changed_files
        run: |
          git fetch origin main
          files=$(git diff --name-only origin/main...HEAD)
          if [ -z "$files" ]; then
            files="(no changes detected)"
          fi
          {
            echo "files<<EOF"
            echo "$files"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Post PR comment
        uses: actions/github-script@v7
        env:
          CHANGED_FILES: ${{ steps.changed_files.outputs.files }}
          READINESS: ${{ needs.smoke_and_e2e.outputs.readiness }}
          READINESS_REASON: ${{ needs.smoke_and_e2e.outputs.readiness_reason }}
          SMOKE_STATUS: ${{ needs.smoke_and_e2e.outputs.smoke_status }}
          E2E_STATUS: ${{ needs.smoke_and_e2e.outputs.e2e_status }}
          E2E_SUMMARY: ${{ needs.smoke_and_e2e.outputs.e2e_summary }}
          RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        with:
          github-token: ${{ secrets.BOT_GITHUB_TOKEN }}
          script: |
            const filesRaw = process.env.CHANGED_FILES || '(no changes detected)';
            const files = filesRaw
              .split('\n')
              .filter(Boolean)
              .map((file) => `- ${file}`)
              .join('\n');

            const formatStatus = (status) => {
              if (status === 'success') return '✅ Passed';
              if (status === 'skipped') return '⚠️ Skipped';
              return '❌ Failed';
            };

            const smokeStatus = formatStatus(process.env.SMOKE_STATUS);
            const e2eStatus = formatStatus(process.env.E2E_STATUS);
            const e2eSummary = process.env.E2E_SUMMARY || '- ⚠️ Playwright results not found';
            const readiness = process.env.READINESS === 'true';
            const readinessReason =
              process.env.READINESS_REASON ||
              'E2E/Smoke tests skipped: BASE_URL not set or backend not available';
            const readinessLine = readiness
              ? 'E2E/Smoke tests executed (BASE_URL present).'
              : readinessReason;

            const body = `## Automated Functional Test Report

**Changed files**
${files}

**Environment readiness**
${readinessLine}

**Smoke tests**: ${smokeStatus}

**E2E flows** (${e2eStatus})
${e2eSummary}

**Deploy note**
Deploy hook not used; Railway deploy happens after merge to main.

**Artifacts**
- Playwright report: ${process.env.RUN_URL} (download artifact \"playwright-report\")`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });

  auto_merge:
    if: github.event_name == 'pull_request' && needs.smoke_and_e2e.result == 'success'
    needs: smoke_and_e2e
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
    steps:
      - name: Ensure GitHub CLI
        run: |
          if ! command -v gh > /dev/null; then
            sudo apt-get update
            sudo apt-get install -y gh
          fi

      - name: Attempt auto-merge
        id: merge
        env:
          GH_TOKEN: ${{ secrets.BOT_GITHUB_TOKEN }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          set +e
          gh pr merge "$PR_URL" --merge --auto 2>&1 | tee merge.log
          status=${PIPESTATUS[0]}
          echo "merge_status=$status" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Comment when auto-merge fails
        if: steps.merge.outputs.merge_status != '0'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.BOT_GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const log = fs.existsSync('merge.log')
              ? fs.readFileSync('merge.log', 'utf8').split('\n').slice(0, 30).join('\n')
              : '(merge.log not found)';
            const body = `## Auto-merge skipped

Unable to enable auto-merge for this PR. This may be due to branch protections or repository settings. Please merge manually once checks are green.`;
            
            const outputBlock = `\n\n**Auto-merge output (first 30 lines)**\n\`\`\`\n${log}\n\`\`\`\n`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body + outputBlock,
            });
